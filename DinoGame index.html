<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dino Game: Action Arrange</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* ËÉåÊôØÁîªÂÉè„Çí„É¶„Éº„Ç∂„ÉºÊåáÂÆö„ÅÆ„ÇÇ„ÅÆ(2.jpg)„Å´Â§âÊõ¥ */
            background-image: url("https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/background-image2.jpg");
            background-size: cover;
            background-color: #222;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: auto;
            max-height: 400px;
            aspect-ratio: 16/9; /* PC„Åß„ÅÆÂü∫Êú¨ÊØîÁéá */
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            background: #f0f0f0;
            border: 4px solid #444;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* ‚ñº‚ñº‚ñº ÁîªÈù¢‰∏ã„ÅÆ„É™„É≥„ÇØ„Ç®„É™„Ç¢ ‚ñº‚ñº‚ñº */
        #footer-ui {
            margin-top: 15px;
            text-align: center;
            z-index: 100;
            background-color: #222;
        }
        #open-license {
            color: #888;
            font-size: 10px;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        #open-license:hover {
            color: #fff;
        }

        /* ‚ñº‚ñº‚ñº „É©„Ç§„Çª„É≥„Çπ„É¢„Éº„ÉÄ„É´ ‚ñº‚ñº‚ñº */
        #license-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #license-modal.active {
            display: flex;
            opacity: 1;
        }
        .license-content {
            width: 85%;
            max-width: 500px;
            max-height: 70%;
            background: #fff;
            border: 4px solid #333;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            color: #333;
            font-family: sans-serif;
        }
        .license-header {
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .license-body {
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.6;
            flex-grow: 1;
        }
        .license-close {
            margin-top: 15px;
            padding: 10px;
            background: #333;
            color: #fff;
            text-align: center;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: transparent;
            image-rendering: pixelated;
            z-index: 1;
        }

        /* ‚ñº‚ñº‚ñº „Éü„É•„Éº„Éà„Éú„Çø„É≥ ‚ñº‚ñº‚ñº */
        #mute-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #333;
            border-radius: 4px;
            z-index: 300;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            pointer-events: auto;
            user-select: none;
        }
        #mute-btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* ‚ñº‚ñº‚ñº „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ ‚ñº‚ñº‚ñº */
        #loading-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #222;
            color: #fff;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }
        .loading-text {
            font-size: 14px;
            margin-bottom: 10px;
            animation: pulse 1.5s infinite;
        }
        .loading-bar-container {
            width: 60%;
            height: 10px;
            background: #444;
            border: 2px solid #fff;
            padding: 2px;
        }
        #loading-bar {
            width: 0%;
            height: 100%;
            background: #ff3366;
            transition: width 0.2s;
        }

        /* ‚ñº‚ñº‚ñº „Çø„Ç§„Éà„É´ÁîªÈù¢ ‚ñº‚ñº‚ñº */
        #title-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            overflow: hidden;
            z-index: 200;
        }
        
        .title-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: pixelated;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        #title-img-1 { transform: translateX(0); z-index: 201; }
        #title-img-2 { transform: translateX(-100%); z-index: 202; }

        .title-ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 205;
            pointer-events: none;
        }

        .title-text {
            font-size: 16px;
            color: #333;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 4px;
            animation: blink 1s infinite;
            margin-top: 15%; 
        }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* ‚ñº‚ñº‚ñº „É°„Éã„É•„ÉºÁîªÈù¢ ‚ñº‚ñº‚ñº */
        #menu-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(240, 240, 240, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow: hidden;
        }
        .menu-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
            text-shadow: 2px 2px 0 #fff;
            text-align: center;
            line-height: 1.5;
            z-index: 102;
        }
        .level-btn {
            margin: 15px;
            padding: 15px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            background: #fff;
            border: 4px solid #333;
            cursor: pointer;
            color: #333;
            width: 200px;
            text-align: center;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
            z-index: 102;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .level-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            background: #eee;
        }
        .level-score {
            font-size: 10px;
            color: #666;
            margin-top: 8px;
            letter-spacing: 1px;
        }

        .menu-char {
            position: absolute;
            bottom: 0;
            width: 150px;
            height: auto;
            image-rendering: pixelated;
            z-index: 101;
            transform: translateY(100%);
        }
        #menu-char-left { left: 20px; }
        #menu-char-right { right: 20px; transform: translateY(100%) scaleX(-1); }

        .slide-in-up { animation: slideInUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slideInUp { 0% { transform: translateY(100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .slide-in-up-right { animation: slideInUpRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slideInUpRight { 0% { transform: translateY(100%) scaleX(-1); opacity: 0; } 100% { transform: translateY(0) scaleX(-1); opacity: 1; } }
        .slide-out-down { animation: slideOutDown 0.3s ease-in forwards; }
        @keyframes slideOutDown { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(100%); opacity: 0; } }
        .slide-out-down-right { animation: slideOutDownRight 0.3s ease-in forwards; }
        @keyframes slideOutDownRight { 0% { transform: translateY(0) scaleX(-1); opacity: 1; } 100% { transform: translateY(100%) scaleX(-1); opacity: 0; } }

        /* „Ç≤„Éº„É†ÂÜÖUI */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .message {
            font-size: 20px;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #fff;
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 4px;
            border: 2px solid #333;
            pointer-events: auto;
        }

        .go-btn {
            display: inline-block;
            margin: 10px 5px 0 5px;
            padding: 10px;
            font-size: 12px;
            background: #333;
            color: #fff;
            border: 2px solid #fff;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
        }
        .go-btn:active { transform: translate(2px, 2px); box-shadow: none; }

        .score-board {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 16px;
            color: #333;
            text-align: right;
            text-shadow: 2px 2px 0 #fff;
            z-index: 5;
        }

        .gauge-container {
            position: absolute;
            top: 40px;
            right: 15px;
            width: 120px;
            height: 8px;
            background: #ccc;
            border: 2px solid #333;
            z-index: 5;
        }
        .gauge-fill {
            height: 100%;
            background: #ff9900;
            width: 0%;
            transition: width 0.1s linear;
        }
        .gauge-ready {
            background: #ff3333 !important;
            box-shadow: 0 0 5px #ff3333;
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            height: 80px;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 20;
        }

        .control-group {
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid #333;
            color: #333;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            user-select: none;
            touch-action: manipulation;
            cursor: pointer;
            box-shadow: 0 4px 0 #333;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #333;
            background: rgba(200, 200, 200, 0.8);
        }

        #btn-dash { width: 70px; height: 70px; background: rgba(220, 220, 220, 0.8); opacity: 0.5; }
        #btn-dash.active { background: #ffcc00; opacity: 1; animation: pulse 1s infinite; border-color: #ff3300; }
        #btn-atk { background: #ffcccc; }
        #btn-jump { background: #ccffcc; width: 70px; height: 70px; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .score-pop {
            position: absolute;
            color: #333;
            font-size: 16px;
            font-weight: bold;
            pointer-events: none;
            animation: popUp 0.8s ease-out forwards;
            z-index: 15;
        }
        .score-pop.smash { color: #ff3333; font-size: 20px; }
        .score-pop.stomp { color: #ff0000; font-size: 22px; font-weight: 900; text-shadow: 2px 2px 0 #fff; }

        @keyframes popUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }

        #pc-controls-help {
            margin-top: 20px;
            color: #888;
            font-size: 12px;
            text-align: center;
            line-height: 1.8;
            background: #111;
            padding: 15px 30px;
            border-radius: 8px;
            border: 1px solid #444;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .key-badge {
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #333;
            color: #fff;
            font-family: monospace;
            margin: 0 2px;
        }
        .control-row {
            margin: 4px 0;
        }

        .hidden { display: none !important; }

        /* ‚ñº‚ñº‚ñº „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„Åë„É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥ ‚ñº‚ñº‚ñº */
        @media (max-width: 600px) {
            body {
                align-items: center;
                justify-content: center;
            }
            #title-layer {
            }
            .title-img {
            height: 100%;
            }
            #game-container {
                width: 98%;
                height: 400px;
                max-height: 600px;
                background-color: #ddd;
                padding: 10px;
                padding-bottom: 20px;
                border-radius: 20px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.8);
                border: 2px solid #555;
                background-image: url('https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/sticker1.png');
                background-position: left 35% bottom;
                background-repeat: no-repeat;
                background-size: 30%;
                
            }

            canvas {
                width: 100%;
                aspect-ratio: 3/1;
                height: auto;
                border: 2px solid #333;
                border-radius: 4px;
                background: #f0f0f0;
                margin-bottom: 20px;
            }

            #title-layer, #menu-layer, #ui-layer, #loading-layer {
                border-radius: 16px; 
            }
            
            #controls {
                position: relative;
                bottom: auto;
                left: auto;
                height: auto;
                width: 100%;
                padding: 0 10px;
                margin-top: 10px;
            }

            .btn {
                width: 65px;
                height: 65px;
                font-size: 10px;
            }
            #btn-dash, #btn-jump {
                width: 75px;
                height: 75px;
            }

            .menu-title { font-size: 16px; margin-bottom: 20px; }
            .level-btn { width: 80%; font-size: 14px; margin: 8px; padding: 12px; }
            .menu-char { width: 80px; }
            .title-text { margin-top: 10%; font-size: 14px; }

            #pc-controls-help {
                display: none;
            }
            .score-pop {
                margin-top: -80px;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <!-- „Éü„É•„Éº„Éà„Éú„Çø„É≥ -->
    <div id="mute-btn">üîä</div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ -->
    <div id="loading-layer">
        <div class="loading-text" id="loading-text">LOADING... 0%</div>
        <div class="loading-bar-container">
            <div id="loading-bar"></div>
        </div>
    </div>

    <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
    <div id="title-layer" class="hidden">
        <img id="title-img-1" class="title-img" alt="Title Logo 1" />
        <img id="title-img-2" class="title-img" alt="Title Logo 2" />
        <div class="title-ui-container">
            <div id="title-text-el" class="title-text">PRESS START</div>
        </div>
    </div>

    <!-- „É°„Éã„É•„ÉºÁîªÈù¢ -->
    <div id="menu-layer" class="hidden">
        <div class="menu-title">SELECT DIFFICULTY</div>
        <div class="level-btn" onclick="selectLevel(1)">
            LEVEL 1
            <span class="level-score" id="score-lv1">HI: 00000</span>
        </div>
        <div class="level-btn" onclick="selectLevel(2)">
            LEVEL 2
            <span class="level-score" id="score-lv2">HI: 00000</span>
        </div>
        <div class="level-btn" onclick="selectLevel(3)">
            LEVEL 3
            <span class="level-score" id="score-lv3">HI: 00000</span>
        </div>
        
        <img id="menu-char-left" class="menu-char" alt="Girl">
        <img id="menu-char-right" class="menu-char" alt="Dino">
    </div>

    <div class="score-board hidden" id="game-ui-score">
        <span id="level-display" style="margin-right: 15px; color: #ff3366;">LV.1</span>
        HI <span id="high-score">00000</span> <span id="current-score">00000</span>
    </div>
    <div class="gauge-container hidden" id="game-ui-gauge">
        <div id="dash-gauge" class="gauge-fill"></div>
    </div>

    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer" class="hidden">
        <div id="start-message" class="message hidden">TAP TO START</div>
        <div id="game-over-message" class="message hidden">
            GAME OVER
            <br><br>
            <div onclick="retryGame()" class="go-btn">RETRY</div>
            <div onclick="backToMenu()" class="go-btn">MENU</div>
        </div>
    </div>
    <div id="effect-container" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>

    <div id="controls" class="hidden">
        <div class="control-group">
            <div id="btn-dash" class="btn">DASH</div>
        </div>
        <div class="control-group" style="align-items: flex-end;">
            <div id="btn-atk" class="btn">ATK</div>
            <div id="btn-jump" class="btn">JUMP</div>
        </div>
    </div>
</div>

<div id="pc-controls-help">
    <div class="control-row">JUMP: <span class="key-badge">SPACE</span> / <span class="key-badge">‚Üë</span></div>
    <div class="control-row">ATK : <span class="key-badge">H</span> / <span class="key-badge">‚Üí</span></div>
    <div class="control-row">DASH: <span class="key-badge">G</span> / <span class="key-badge">‚Üì</span></div>
</div>
<div id="footer-ui">
    <a id="open-license">CREDIT</a>
</div>

<div id="license-modal">
    <div class="license-content">
        <div class="license-header">CREDIT</div>
        <div class="license-body">
            <p><strong>Game Design & Programming:</strong><br>Gemini (Google AI)</p>
            <p><strong>Prompt Keypuncher:</strong><br><a href="https://x.com/msoyu62k22">Harris(msoyu62k22)</a></p>
            <p><strong>Assets Credit:</strong></p>
            <ul>
                <li>BGM: "DINO DASH" (Suno AI)</li>
                <li>Backgrounds & Clouds: Nano Banana (Google AI)</li>
                <li>Player & Enemy Sprites: Nano Banana (Google AI)</li>
                <li>Sound Effects: Generated via Web Audio API</li>
            </ul>
            <p><strong>License / About:</strong></p>
            <p>This is a non-profit, fan-made tribute to the Google Chrome "Dino Game" and is unaffiliated with Google. Approximately 99% of the content, including code, visuals, and audio, was generated by AI tools with minor manual edits. I disclaim ownership rights to the AI-generated assets. Any use must adhere to the terms of service of the respective AI platforms used for their generation.</p>
        </div>
        <div class="license-close" id="license-close">CLOSE</div>
    </div>
</div>

<script>
    // ‚ñº‚ñº‚ñº „Ç´„Çπ„Çø„É†„Ç¢„Çª„ÉÉ„ÉàË®≠ÂÆö„Ç®„É™„Ç¢ (ÊúÄÊñ∞URLÂèçÊò†Ê∏à„Åø) ‚ñº‚ñº‚ñº
    const CUSTOM_BGM_URL = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/DINODASHmin.mp3"; 

    // „ÄêËÉåÊôØ„ÉªÁí∞Â¢É„Äë
    const CUSTOM_BG     = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/background1.png"; 
    const CUSTOM_GROUND = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/background2.png"; 
    const CUSTOM_CLOUD  = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/cloud.png"; 

    // „Äê„Éó„É¨„Ç§„É§„ÉºÁîªÂÉè„Äë
    const CUSTOM_DINO_RUN_1    = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/dinorun1.png"; 
    const CUSTOM_DINO_RUN_2    = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/dinorun2.png"; 
    const CUSTOM_DINO_HEADBUTT = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/headbutt.png"; 
    const CUSTOM_DINO_CRASH    = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/crash2.png"; 

    // „ÄêÈöúÂÆ≥Áâ©ÁîªÂÉè„Äë
    const CUSTOM_CACTUS_1 = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/cacuts1.png"; 
    const CUSTOM_CACTUS_2 = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/cacuts2.png"; 
    const CUSTOM_CACTUS_3 = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/cacuts3.png"; 

    // „Äê„Çø„Ç§„Éà„É´ÁîªÂÉè„Äë(PCÁî®)
    const CUSTOM_TITLE_1_PC = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/titlepc1.png"; 
    const CUSTOM_TITLE_2_PC = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/titlepc2-.png"; 

    // „Äê„Çø„Ç§„Éà„É´ÁîªÂÉè„Äë(„Çπ„Éû„ÉõÁî®)
    const CUSTOM_TITLE_1_SP = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/titlesp1.png"; 
    const CUSTOM_TITLE_2_SP = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/titlesp2.png"; 

    // „Äê„É°„Éã„É•„ÉºË£ÖÈ£æÁîªÂÉè„Äë
    const CUSTOM_MENU_LEFT  = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/menuleft.png"; 
    const CUSTOM_MENU_RIGHT = "https://raw.githubusercontent.com/edgd3o4tgu878y239/dinodash/refs/heads/main/dino-image/menuright.png"; 
    
    // ‚ñ≤‚ñ≤‚ñ≤ „Ç´„Çπ„Çø„É†„Ç¢„Çª„ÉÉ„ÉàË®≠ÂÆö„Åì„Åì„Åæ„Åß ‚ñ≤‚ñ≤‚ñ≤
    

    // ‚ñº‚ñº‚ñº ‰ª•‰∏ã„ÄÅ„Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ‚ñº‚ñº‚ñº

    const SVG_STYLE = `<style>.dino{fill:#333}.skin{fill:#fff0e0}.hair{fill:#a0a0a0}.hoodie{fill:#ff3366}.shorts{fill:#222}.eye{fill:#6600cc}.shoe{fill:#cc0000}</style>`;
    const createSvgDataUri = (content) => 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>${SVG_STYLE}${content}</svg>`);

    // „Éá„Éï„Ç©„É´„Éà„Ç¢„Çª„ÉÉ„Éà(„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®)
    const DEFAULT_DINO_RUN_1 = createSvgDataUri(`<path class='dino' d='M40 16h16v12h-6v2h6v6h-4v2h-4v2h-2v4h-2v4h2v2h2v6h-4v-4h-2v-2h-2v-2h-2v6h-4v-4h-2v-4h-2v-2h-2v-2h-2v-6h2v-2h2v-2h2v-2h2v-2h2v-2h2v-4h2v-4h2v-4h6v-2h-2v-2h2v-2h8z'/><rect class='skin' x='24' y='10' width='8' height='8'/><rect class='hair' x='22' y='8' width='12' height='4'/><rect class='hair' x='22' y='8' width='2' height='10'/><rect class='hair' x='32' y='8' width='2' height='8'/><rect class='eye' x='29' y='13' width='2' height='2'/><path class='hoodie' d='M24 18h10v10h-2v2h-2v-2h-2v2h-2v-2h-2z'/><path class='hoodie' d='M20 18h4v6h-4z'/><rect class='skin' x='30' y='22' width='4' height='3'/><rect class='skin' x='28' y='28' width='4' height='6'/><rect class='shorts' x='26' y='26' width='8' height='4'/><rect class='shoe' x='28' y='34' width='5' height='3'/>`);
    const DEFAULT_DINO_RUN_2 = createSvgDataUri(`<path class='dino' d='M40 15h16v12h-6v2h6v6h-4v2h-4v2h-2v4h-2v4h2v2h-2v4h-4v-4h-2v-4h-4v6h-4v-4h-2v-4h-2v-2h-2v-2h-2v-6h2v-2h2v-2h2v-2h2v-2h2v-2h2v-4h2v-4h2v-4h6v-2h-2v-2h2v-2h8z'/><g transform='translate(0, -1)'><rect class='skin' x='24' y='10' width='8' height='8'/><rect class='hair' x='22' y='8' width='12' height='4'/><rect class='hair' x='22' y='8' width='2' height='10'/><rect class='hair' x='32' y='8' width='2' height='8'/><rect class='eye' x='29' y='13' width='2' height='2'/><path class='hoodie' d='M24 18h10v10h-2v2h-2v-2h-2v2h-2v-2h-2z'/><path class='hoodie' d='M20 18h4v6h-4z'/><rect class='skin' x='30' y='22' width='4' height='3'/><rect class='skin' x='28' y='28' width='4' height='6'/><rect class='shorts' x='26' y='26' width='8' height='4'/><rect class='shoe' x='28' y='34' width='5' height='3'/></g>`);
    const DEFAULT_DINO_HEADBUTT = createSvgDataUri(`<g transform='translate(6, 4)'><path class='dino' d='M44 16h16v12h-6v2h6v6h-4v2h-4v2h-2v4h-2v4h2v2h2v6h-4v-4h-2v-2h-2v-2h-2v6h-4v-4h-2v-4h-2v-2h-2v-2h-2v-6h2v-2h2v-2h2v-2h2v-2h2v-2h2v-4h2v-4h2v-4h6v-2h-2v-2h2v-2h8z'/><rect fill='#fff' x='56' y='14' width='8' height='2'/><rect fill='#fff' x='58' y='18' width='6' height='2'/></g><g transform='translate(6, 4)'><rect class='skin' x='26' y='12' width='8' height='8'/><rect class='hair' x='24' y='10' width='12' height='4'/><rect class='hair' x='24' y='10' width='2' height='10'/><rect class='hair' x='34' y='10' width='2' height='8'/><rect class='eye' x='31' y='15' width='2' height='2'/><path class='hoodie' d='M26 20h10v10h-2v2h-2v-2h-2v2h-2v-2h-2z'/><path class='hoodie' d='M22 20h4v6h-4z'/><rect class='skin' x='32' y='24' width='6' height='3'/><rect class='skin' x='28' y='30' width='4' height='6'/><rect class='shorts' x='26' y='28' width='8' height='4'/><rect class='shoe' x='28' y='36' width='5' height='3'/></g>`);
    const DEFAULT_DINO_CRASH = createSvgDataUri(`<path class='dino' d='M40 16h16v12h-6v2h6v6h-4v2h-4v2h-2v4h-2v4h2v2h2v6h-4v-4h-2v-2h-2v-2h-2v6h-4v-4h-2v-4h-2v-2h-2v-2h-2v-6h2v-2h2v-2h2v-2h2v-2h2v-4h2v-4h6v-2h-2v-2h2v-2h8z'/><rect fill='%23fff' x='46' y='20' width='4' height='4'/><rect fill='%23333' x='47' y='21' width='2' height='2'/><g transform='translate(0, -2)'><rect class='skin' x='24' y='10' width='8' height='8'/><rect class='hair' x='22' y='6' width='12' height='6'/><rect class='hair' x='20' y='8' width='2' height='8'/><rect class='hair' x='34' y='8' width='2' height='6'/><rect class='eye' x='26' y='13' width='2' height='2'/><rect class='eye' x='30' y='13' width='2' height='2'/><rect fill='%23000' x='28' y='16' width='2' height='2'/><path class='hoodie' d='M24 18h10v10h-2v2h-2v-2h-2v2h-2v-2h-2z'/><path class='hoodie' d='M18 16h6v4h-6z'/><rect class='skin' x='16' y='14' width='3' height='4'/><rect class='skin' x='28' y='28' width='4' height='6'/><rect class='shorts' x='26' y='26' width='8' height='4'/><rect class='shoe' x='28' y='34' width='5' height='3'/></g>`);

    const DEFAULT_TITLE_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='160' viewBox='0 0 400 160'%3E%3Crect width='400' height='160' fill='%23e0e0e0'/%3E%3Ctext x='50' y='100' font-family='monospace' font-size='48' font-weight='bold' fill='%23333'%3EDINO RUN%3C/text%3E%3C/svg%3E";
    const DEFAULT_TITLE_IMG_2 = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='160' viewBox='0 0 400 160'%3E%3Crect width='400' height='160' fill='%23ffffcc'/%3E%3Ctext x='50' y='100' font-family='monospace' font-size='48' font-weight='bold' fill='%23ff3366'%3EDINO RUN%3C/text%3E%3Cpath d='M20,120 L380,120' stroke='%23ff9900' stroke-width='8' /%3E%3C/svg%3E";

    const DEFAULT_MENU_LEFT = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 64 64'%3E" + SVG_STYLE + "%3Crect class='skin' x='24' y='10' width='8' height='8'/%3E%3Crect class='hair' x='22' y='8' width='12' height='4'/%3E%3Crect class='hair' x='22' y='8' width='2' height='10'/%3E%3Crect class='hair' x='32' y='8' width='2' height='8'/%3E%3Crect class='eye' x='29' y='13' width='2' height='2'/%3E%3Cpath class='hoodie' d='M24 18h10v10h-2v2h-2v-2h-2v2h-2v-2h-2z'/%3E%3Cpath class='hoodie' d='M20 18h4v6h-4z'/%3E%3Crect class='skin' x='30' y='22' width='4' height='3'/%3E%3Crect class='skin' x='28' y='28' width='4' height='6'/%3E%3Crect class='shorts' x='26' y='26' width='8' height='4'/%3E%3Crect class='shoe' x='28' y='34' width='5' height='3'/%3E%3C/svg%3E";
    const DEFAULT_MENU_RIGHT = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 64 64'%3E" + SVG_STYLE + "%3Cpath class='dino' d='M40 16h16v12h-6v2h6v6h-4v2h-4v2h-2v4h-2v4h2v2h2v6h-4v-4h-2v-2h-2v-2h-2v6h-4v-4h-2v-4h-2v-2h-2v-2h-2v-6h2v-2h2v-2h2v-2h2v-2h2v-2h2v-4h2v-4h6v-2h-2v-2h2v-2h8z'/%3E%3C/svg%3E";

    const IMG_DINO_RUN_1 = CUSTOM_DINO_RUN_1 || DEFAULT_DINO_RUN_1;
    const IMG_DINO_RUN_2 = CUSTOM_DINO_RUN_2 || DEFAULT_DINO_RUN_2;
    const IMG_DINO_HEADBUTT = CUSTOM_DINO_HEADBUTT || DEFAULT_DINO_HEADBUTT;
    const IMG_DINO_CRASH = CUSTOM_DINO_CRASH || DEFAULT_DINO_CRASH;

    const isMobile = window.matchMedia('(max-width: 600px)').matches;
    const TITLE_IMG_SRC = (isMobile && CUSTOM_TITLE_1_SP) ? CUSTOM_TITLE_1_SP : (CUSTOM_TITLE_1_PC || DEFAULT_TITLE_IMG);
    const TITLE_IMG_SRC_2 = (isMobile && CUSTOM_TITLE_2_SP) ? CUSTOM_TITLE_2_SP : (CUSTOM_TITLE_2_PC || DEFAULT_TITLE_IMG_2);

    const MENU_CHAR_LEFT = CUSTOM_MENU_LEFT || DEFAULT_MENU_LEFT;
    const MENU_CHAR_RIGHT = CUSTOM_MENU_RIGHT || DEFAULT_MENU_RIGHT;
    const BGM_SRC = CUSTOM_BGM_URL;


    // ‚ñº‚ñº‚ñº AssetLoader ‚ñº‚ñº‚ñº
    class AssetLoader {
        constructor() {
            this.assets = [];
            this.loadedCount = 0;
            this.totalCount = 0;
            this.loadedImages = {};
            this.loadedAudio = {};
        }

        add(key, src, type = 'image') {
            if (src) {
                this.assets.push({ key, src, type });
            }
        }

        start(onProgress, onComplete) {
            this.totalCount = this.assets.length;
            
            if (this.totalCount === 0) {
                if (onComplete) onComplete();
                return;
            }

            this.assets.forEach(asset => {
                if (asset.type === 'image') {
                    const img = new Image();
                    img.onload = () => {
                        this.loadedImages[asset.key] = img;
                        this.tick(onProgress, onComplete);
                    };
                    img.onerror = () => {
                        console.warn(`Failed to load image: ${asset.src}`);
                        this.tick(onProgress, onComplete);
                    };
                    img.src = asset.src;
                } else if (asset.type === 'audio') {
                    const audio = new Audio();
                    const onAudioLoaded = () => {
                        this.loadedAudio[asset.key] = audio;
                        audio.removeEventListener('canplaythrough', onAudioLoaded);
                        audio.removeEventListener('error', onAudioError);
                        this.tick(onProgress, onComplete);
                    };
                    const onAudioError = () => {
                        console.warn(`Failed to load audio: ${asset.src}`);
                        audio.removeEventListener('canplaythrough', onAudioLoaded);
                        audio.removeEventListener('error', onAudioError);
                        this.tick(onProgress, onComplete);
                    }

                    audio.addEventListener('canplaythrough', onAudioLoaded);
                    audio.addEventListener('error', onAudioError);
                    audio.src = asset.src;
                    audio.load();
                }
            });
        }

        tick(onProgress, onComplete) {
            this.loadedCount++;
            const percent = Math.floor((this.loadedCount / this.totalCount) * 100);
            if (onProgress) onProgress(percent);
            
            if (this.loadedCount >= this.totalCount) {
                if (onComplete) onComplete();
            }
        }
    }


    // ‚ñº‚ñº‚ñº Èü≥Â£∞ÁÆ°ÁêÜ„ÇØ„É©„Çπ („Çπ„Éû„ÉõÂØæÁ≠ñÂº∑ÂåñÁâà) ‚ñº‚ñº‚ñº
    class SoundManager {
        constructor() {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.enabled = true;
            this.bgm = null;
            this.bgmInterval = null;
            this.isMuted = false;

            const btn = document.getElementById('mute-btn');
            if (btn) {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    this.toggleMute();
                };
            }
        }

        setPreloadedBgm(audioObj) {
            if (audioObj) {
                this.bgm = audioObj;
                this.bgm.loop = true;
                this.bgm.volume = 0.25;
            }
        }
        
        // ‚òÖ‰øÆÊ≠£ÁÇπ: „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÁ¢∫ÂÆü„Å´„ÄåÊ∏©„ÇÅ„Çã„ÄçÂá¶ÁêÜ
        // „Çø„ÉÉ„ÉóÁõ¥Âæå„Å´„Åì„Çå„ÇíÂëº„Å∂„Åì„Å®„Åß„ÄÅ‰ª•Èôç„ÅÆ„Ç™„Éº„Éá„Ç£„Ç™ÂÜçÁîü„ÇíË®±ÂèØ„Åï„Åõ„Çã
        warmUp() {
            if (this.ctx.state === 'suspended') {
                this.ctx.resume().catch(e => console.log(e));
            }
            // ÁÑ°Èü≥„ÅÆ„Ç™„Ç∑„É¨„Éº„Çø„Éº„Çí‰∏ÄÁû¨È≥¥„Çâ„Åô
            try {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                gain.gain.value = 0; // ÁÑ°Èü≥
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(0);
                osc.stop(0.01);
            } catch(e) {
                // „Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
            }
        }

        toggleMute() {
            this.isMuted = !this.isMuted;
            const btn = document.getElementById('mute-btn');
            
            if (this.isMuted) {
                this.stopBgm();
                btn.innerText = "üîá";
                btn.style.background = "rgba(200, 200, 200, 0.9)";
            } else {
                btn.innerText = "üîä";
                btn.style.background = "rgba(255, 255, 255, 0.9)";
                if (typeof titlePhase !== 'undefined' && titlePhase > 0) {
                    this.warmUp(); // Ëß£Èô§ÊôÇ„ÇÇÊ∏©„ÇÅ„Çã
                    this.playBgm();
                }
            }
        }
        
        resumeContext() {
            if (this.ctx.state === 'suspended') return this.ctx.resume();
            return Promise.resolve();
        }

        playBgm() {
            if (this.isMuted) return;
            if (this.bgm) {
                // Âøµ„ÅÆ„Åü„ÇÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶resume„ÇíË©¶„Åø„Çã
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                this.bgm.currentTime = 0;
                // Promise„ÅÆ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Çí„Åó„Å¶„ÄÅÂ§±Êïó„Åó„Åü„Çâ„É™„Éà„É©„Ç§„Å™„Å©„ÇíËÄÉÊÖÆ„Åô„Çã
                const p = this.bgm.play();
                if (p !== undefined) {
                    p.catch(error => {
                        console.log('BGM play failed (Autoplay policy?):', error);
                        // Â§±Êïó„Åó„ÅüÂ†¥Âêà„Åß„ÇÇ„ÄÅÊ¨°„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅßÈ≥¥„Çã„Çà„ÅÜ„Å´„Éï„É©„Ç∞„Å™„Å©„ÇíÁ´ã„Å¶„ÇãÊâã„ÇÇ„ÅÇ„Çã„Åå
                        // „Åì„Åì„Åß„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´Âá∫Âäõ„Å´„Å®„Å©„ÇÅ„Çã
                    });
                }
            } else {
                this.startSimpleBgm();
            }
        }
        stopBgm() {
            if (this.bgm) {
                this.bgm.pause();
                this.bgm.currentTime = 0;
            }
            if (this.bgmInterval) {
                clearInterval(this.bgmInterval);
                this.bgmInterval = null;
            }
        }
        startSimpleBgm() {
            if (this.bgmInterval) return;
            if (this.isMuted) return;
            let noteIndex = 0;
            const notes = [261.63, 329.63, 392.00, 523.25, 261.63, 329.63, 392.00, 523.25, 220.00, 261.63, 329.63, 440.00, 196.00, 246.94, 293.66, 392.00];
            const interval = 60000 / 150 / 2;
            this.bgmInterval = setInterval(() => {
                if (this.isMuted) { this.stopBgm(); return; }
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const freq = notes[noteIndex % notes.length];
                this.playTone('square', freq, 0.1, 0, 0.05);
                if (noteIndex % 4 === 0) this.playTone('triangle', freq / 2, 0.2, 0, 0.05);
                noteIndex++;
            }, interval);
        }
        playTone(type, freq, duration, slide = 0, vol = 0.1) {
            if (!this.enabled || this.isMuted) return;
            // ÊºîÂ•èÊôÇ„ÇÇ„Åì„Åæ„ÇÅ„Å´resumeÁ¢∫Ë™ç
            if(this.ctx.state === 'suspended') this.ctx.resume().catch(()=>{});
            
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            if (slide !== 0) osc.frequency.linearRampToValueAtTime(freq + slide, this.ctx.currentTime + duration);
            else if (type === 'square') osc.frequency.exponentialRampToValueAtTime(freq * 4, this.ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime); 
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        }
        playJump() { this.playTone('square', 200, 0.15, 0, 0.25); }
        playScore() { this.playTone('sine', 800, 0.3, 0, 0.2); }
        playGameOver() { this.playTone('sawtooth', 150, 0.5, 0, 0.25); }
        playStomp() { this.playTone('triangle', 300, 0.1, 100, 0.25); }
        playHeadbuttSwing() { this.playTone('sine', 150, 0.1, -50, 0.25); }
        playDashStart() {
            if (!this.enabled || this.isMuted) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.5);
        }
        playSmash() { 
            if (!this.enabled || this.isMuted) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.2);
        }
        playSelect() {
            if(this.isMuted) return;
            this.playTone('sine', 440, 0.1, 0, 0.3);
            setTimeout(() => this.playTone('sine', 880, 0.2, 0, 0.3), 50);
        }
    }

    const soundManager = new SoundManager();

    const CONFIG = {
        CANVAS_WIDTH: 900,
        CANVAS_HEIGHT: 300,
        GRAVITY: 1.6,      
        JUMP_FORCE: -22,   
        BOUNCE_FORCE: -15, 
        GROUND_Y: 250,
        GAME_SPEED_START: 6.0, 
        MAX_SPEED: 30.0,       
        ACCELERATION: 0.001,
        SPAWN_RATE_MIN: 100,
        SPAWN_RATE_MAX: 220,
        DINO_X: 60,
        STOMP_SCORE: 20,
        HEADBUTT_SCORE: 10, 
        HEADBUTT_DURATION: 6,
        HEADBUTT_COOLDOWN: 50, 
        HIT_STOP_DURATION: 8,
        DASH_GAUGE_MAX: 150,
        DASH_DURATION: 450,
        DASH_SPEED_MULTIPLIER: 1.2,
        INVINCIBLE_DURATION: 60,
        SCORE_MULTIPLIER: 1.0,
        FPS: 60,
        INTRO_SPEED: 8
    };

    const LEVELS = {
        1: { SPEED: 10.0,  ACCEL: 0.0020, MAX_SPEED: 18.0, SPAWN_MIN: 50, SPAWN_MAX: 160, SCORE_MULT: 1.0 },
        2: { SPEED: 14.0, ACCEL: 0.0025, MAX_SPEED: 28.0, SPAWN_MIN: 40, SPAWN_MAX: 120, SCORE_MULT: 1.5 },
        3: { SPEED: 18.0, ACCEL: 0.0030, MAX_SPEED: 80.0, SPAWN_MIN: 30, SPAWN_MAX: 90,  SCORE_MULT: 3.0 }
    };

    let gameInstance = null;
    let titlePhase = 0; 
    let currentLevel = 1;

    class SpriteManager {
        constructor() { this.images = {}; }
        setImage(key, imgObj) {
            this.images[key] = imgObj;
        }
        load(key, src) { 
            if (!src) return;
            const img = new Image(); 
            img.src = src; 
            this.images[key] = img; 
        }
        get(key) { return this.images[key]; }
    }
    const sprites = new SpriteManager();

    const titleImg1 = document.getElementById('title-img-1');
    const titleImg2 = document.getElementById('title-img-2');
    const titleTextEl = document.getElementById('title-text-el');
    const loadingLayer = document.getElementById('loading-layer');
    const loadingText = document.getElementById('loading-text');
    const loadingBar = document.getElementById('loading-bar');
    const titleLayer = document.getElementById('title-layer');


    window.onload = () => {
        const loader = new AssetLoader();
        
        loader.add('dino_run_1', IMG_DINO_RUN_1);
        loader.add('dino_run_2', IMG_DINO_RUN_2);
        loader.add('dino_headbutt', IMG_DINO_HEADBUTT);
        loader.add('dino_crash', IMG_DINO_CRASH);
        loader.add('bg', CUSTOM_BG);
        loader.add('ground', CUSTOM_GROUND);
        loader.add('cloud', CUSTOM_CLOUD);
        loader.add('cactus_1', CUSTOM_CACTUS_1);
        loader.add('cactus_2', CUSTOM_CACTUS_2);
        loader.add('cactus_3', CUSTOM_CACTUS_3);
        loader.add('title_1', TITLE_IMG_SRC);
        loader.add('title_2', TITLE_IMG_SRC_2);
        loader.add('menu_left', MENU_CHAR_LEFT);
        loader.add('menu_right', MENU_CHAR_RIGHT);

        if (BGM_SRC && BGM_SRC.length > 5) {
            loader.add('bgm', BGM_SRC, 'audio');
        }

        loader.start(
            (percent) => {
                loadingText.innerText = `LOADING... ${percent}%`;
                loadingBar.style.width = `${percent}%`;
            },
            () => {
                for (const key in loader.loadedImages) {
                    sprites.setImage(key, loader.loadedImages[key]);
                }
                
                titleImg1.src = TITLE_IMG_SRC;
                titleImg2.src = TITLE_IMG_SRC_2;
                document.getElementById('menu-char-left').src = MENU_CHAR_LEFT;
                document.getElementById('menu-char-right').src = MENU_CHAR_RIGHT;

                if (loader.loadedAudio['bgm']) {
                    soundManager.setPreloadedBgm(loader.loadedAudio['bgm']);
                } else if (BGM_SRC) {
                     const audio = new Audio(BGM_SRC);
                     soundManager.setPreloadedBgm(audio);
                }

                setTimeout(() => {
                    loadingLayer.style.opacity = 0;
                    setTimeout(() => {
                        loadingLayer.style.display = 'none';
                        titleLayer.classList.remove('hidden');
                    }, 500);
                }, 200);
                
                updateMenuHighScores();
            }
        );
    };

    function updateMenuHighScores() {
        for(let i=1; i<=3; i++) {
            const score = Number(localStorage.getItem(`dinoHighScore_Level${i}`)) || 0;
            const el = document.getElementById(`score-lv${i}`);
            if(el) el.innerText = `HI: ${score.toString().padStart(5, '0')}`;
        }
    }

    function showMenu() {
        const menu = document.getElementById('menu-layer');
        const charL = document.getElementById('menu-char-left');
        const charR = document.getElementById('menu-char-right');

        updateMenuHighScores();

        charL.classList.remove('slide-in-up', 'slide-out-down');
        charR.classList.remove('slide-in-up-right', 'slide-out-down-right');
        
        void charL.offsetWidth; 

        menu.classList.remove('hidden');
        charL.classList.add('slide-in-up');
        charR.classList.add('slide-in-up-right');
    }

    function hideMenu(onComplete) {
        const charL = document.getElementById('menu-char-left');
        const charR = document.getElementById('menu-char-right');

        charL.classList.remove('slide-in-up');
        charL.classList.add('slide-out-down');
        
        charR.classList.remove('slide-in-up-right');
        charR.classList.add('slide-out-down-right');

        setTimeout(() => {
            document.getElementById('menu-layer').classList.add('hidden');
            if (onComplete) onComplete();
        }, 300);
    }

    const openLicense = document.getElementById('open-license');
    const licenseModal = document.getElementById('license-modal');
    const licenseClose = document.getElementById('license-close');

    openLicense.onclick = () => { licenseModal.style.display = "flex"; setTimeout(() => licenseModal.classList.add('active'), 10); };
    licenseClose.onclick = () => { licenseModal.classList.remove('active'); setTimeout(() => licenseModal.style.display = "none", 300); };
    licenseModal.onclick = (e) => { if (e.target === licenseModal) licenseClose.onclick(); };

    // ‚ñº‚ñº‚ñº „Çø„Ç§„Éà„É´Êìç‰Ωú„É≠„Ç∏„ÉÉ„ÇØ‰øÆÊ≠£ ‚ñº‚ñº‚ñº
    function handleTitleInteraction() {
        if (titleLayer.classList.contains('hidden')) return;

        // Phase 0 -> Phase 1
        if (titlePhase === 0) {
            // ‚òÖÂ§âÊõ¥ÁÇπ: „Åì„Åì„ÅßÂº∑Âäõ„Å´WarmUp„Çí„Åã„Åë„Çã
            soundManager.warmUp();
            soundManager.playSelect();
            soundManager.playBgm(); // Âç≥Â∫ß„Å´BGMÂÜçÁîüÊåáÁ§∫
            
            titleImg1.style.transform = 'translateX(100%)';
            titleImg2.style.transform = 'translateX(0)';
            
            titleTextEl.innerText = "TAP TO MENU";
            titleTextEl.style.color = "#ff3366";
            
            titlePhase = 1;
        } 
        // Phase 1 -> Phase 2
        else if (titlePhase === 1) {
            soundManager.resumeContext(); // „Åì„Åì„Åß„ÇÇÂøµÊäº„Åó
            soundManager.playDashStart(); 
            
            titleImg2.style.transform = 'translateX(100%)';
            titleTextEl.style.opacity = '0';

            setTimeout(() => {
                titleLayer.classList.add('hidden');
                showMenu();
            }, 350);
        }
    }

    titleLayer.addEventListener('click', handleTitleInteraction);
    titleLayer.addEventListener('touchstart', (e) => { e.preventDefault(); handleTitleInteraction(); }, {passive: false});
    window.addEventListener('keydown', (e) => {
        if (!titleLayer.classList.contains('hidden')) {
            handleTitleInteraction();
        }
    });

    function selectLevel(level) {
        currentLevel = level;
        hideMenu(() => {
            startGame(level);
        });
    }

    function startGame(level) {
        if (gameInstance) {
            gameInstance.destroy();
            gameInstance = null;
        }

        const setting = LEVELS[level];
        CONFIG.GAME_SPEED_START = setting.SPEED;
        CONFIG.ACCELERATION = setting.ACCEL;
        CONFIG.MAX_SPEED = setting.MAX_SPEED;
        CONFIG.SPAWN_RATE_MIN = setting.SPAWN_MIN;
        CONFIG.SPAWN_RATE_MAX = setting.SPAWN_MAX;
        CONFIG.SCORE_MULTIPLIER = setting.SCORE_MULT;
        
        CONFIG.GRAVITY = 1.6;
        CONFIG.JUMP_FORCE = -22;

        document.getElementById('ui-layer').classList.remove('hidden');
        document.getElementById('game-ui-score').classList.remove('hidden');
        document.getElementById('game-ui-gauge').classList.remove('hidden');
        document.getElementById('controls').classList.remove('hidden');
        
        document.getElementById('game-over-message').classList.add('hidden');
        document.getElementById('level-display').innerText = `LV.${level}`;

        gameInstance = new Game();
    }

    function backToMenu() {
        if (gameInstance) {
            gameInstance.destroy();
            gameInstance = null;
        }
        document.getElementById('ui-layer').classList.add('hidden');
        document.getElementById('game-ui-score').classList.add('hidden');
        document.getElementById('game-ui-gauge').classList.add('hidden');
        document.getElementById('controls').classList.add('hidden');

        showMenu();
    }

    function retryGame() {
        if (gameInstance) {
            gameInstance.reset();
        }
    }

    class ScrollingLayer {
        constructor(imgKey, speedFactor, yOffset = 0, isGround = false) {
            this.imgKey = imgKey;
            this.speedFactor = speedFactor;
            this.x = 0;
            this.yOffset = yOffset;
            this.isGround = isGround;
        }

        update(gameSpeed) {
            this.x -= gameSpeed * this.speedFactor;
        }

        draw(ctx, canvasWidth, canvasHeight) {
            const img = sprites.get(this.imgKey);
            if (img && img.complete && img.naturalWidth !== 0) {
                const w = img.naturalWidth;
                const h = img.naturalHeight;
                
                let drawY = this.yOffset;
                if (this.isGround) {
                     drawY = CONFIG.GROUND_Y;
                }

                let renderX = this.x % w;
                if (renderX > 0) renderX -= w;

                while (renderX < canvasWidth) {
                    ctx.drawImage(img, Math.floor(renderX), drawY, w + 1, h);
                    renderX += w;
                }
            } else {
                if (this.isGround) {
                    ctx.beginPath();
                    ctx.moveTo(0, CONFIG.GROUND_Y);
                    ctx.lineTo(canvasWidth, CONFIG.GROUND_Y);
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        }
    }

    class Particle {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.vx = (Math.random() - 0.5) * 10;
            this.vy = (Math.random() - 1.5) * 10;
            this.size = Math.random() * 6 + 4;
            this.color = '#333';
            this.life = 1.0;
            this.decay = Math.random() * 0.03 + 0.02;
            this.gravity = 0.5;
        }
        update() {
            this.vx *= 0.95; this.vy += this.gravity;
            this.x += this.vx; this.y += this.vy;
            this.life -= this.decay;
        }
        draw(ctx) {
            ctx.fillStyle = this.color;
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillRect(this.x, this.y, this.size, this.size);
            ctx.globalAlpha = 1.0;
        }
    }

    class Dino {
        constructor() {
            this.width = 80; this.height = 80;
            this.x = -100;
            this.targetX = CONFIG.DINO_X;
            this.y = CONFIG.GROUND_Y - this.height;
            this.dy = 0; this.jumpPower = CONFIG.JUMP_FORCE;
            this.grounded = true; this.crashed = false;
            this.timer = 0; this.legFrame = 0;
            this.isHeadbutting = false; this.headbuttTimer = 0; this.headbuttCooldown = 0;
            this.trail = []; 
            this.introPhase = true; 
        }
        
        updateIntro() {
            if (this.x < this.targetX) {
                this.x += CONFIG.INTRO_SPEED;
                this.timer++; 
                if (this.timer > 4) { this.legFrame = !this.legFrame; this.timer = 0; }
                
                if (this.x >= this.targetX) {
                    this.x = this.targetX;
                    this.introPhase = false;
                    return true;
                }
            }
            return false;
        }

        jump() {
            if (this.grounded && !this.isHeadbutting && !this.introPhase) {
                this.dy = this.jumpPower; this.grounded = false; return true;
            }
            return false;
        }
        triggerHeadbutt() {
            if (!this.headbuttCooldown && !this.isHeadbutting && !this.crashed && !this.introPhase) {
                this.isHeadbutting = true;
                this.headbuttTimer = CONFIG.HEADBUTT_DURATION;
                this.headbuttCooldown = CONFIG.HEADBUTT_COOLDOWN;
                return true;
            }
            return false;
        }
        bounce() { this.dy = CONFIG.BOUNCE_FORCE; this.grounded = false; }
        update(isDashing) {
            this.dy += CONFIG.GRAVITY; this.y += this.dy;
            if (this.y > CONFIG.GROUND_Y - this.height) { this.y = CONFIG.GROUND_Y - this.height; this.dy = 0; this.grounded = true; } else { this.grounded = false; }
            if (isDashing) {
                this.trail.push({ x: this.x, y: this.y, imgKey: 'dino_headbutt', alpha: 0.6 });
                if (this.trail.length > 5) this.trail.shift();
            } else { this.trail = []; }
            if (this.isHeadbutting) { this.headbuttTimer--; if (this.headbuttTimer <= 0) this.isHeadbutting = false; }
            if (this.headbuttCooldown > 0) this.headbuttCooldown--;
            this.timer++; if (this.timer > 6) { this.legFrame = !this.legFrame; this.timer = 0; }
        }
        draw(ctx, isDashing) {
            if (isDashing) {
                this.trail.forEach((t, i) => {
                    const img = sprites.get(t.imgKey);
                    if (img && img.complete) {
                        ctx.save(); ctx.globalAlpha = t.alpha * (i / this.trail.length);
                        ctx.drawImage(img, t.x - (this.trail.length - i) * 10, t.y, this.width, this.height);
                        ctx.restore();
                    }
                });
            }
            let imgKey = 'dino_run_1';
            
            if (this.crashed) {
                imgKey = 'dino_crash';
            } else if (isDashing || this.isHeadbutting) {
                imgKey = 'dino_headbutt';
            } else if (this.legFrame) {
                imgKey = 'dino_run_2';
            }

            const img = sprites.get(imgKey);
            if (this.headbuttCooldown > 0 && !this.isHeadbutting && !isDashing) ctx.globalAlpha = 0.7; else ctx.globalAlpha = 1.0;
            if (img && img.complete && img.naturalWidth !== 0) ctx.drawImage(img, this.x, this.y, this.width, this.height);
            else { ctx.fillStyle = '#ff3366'; ctx.fillRect(this.x, this.y, this.width, this.height); }
            ctx.globalAlpha = 1.0;
        }
        getBounds() { return { x: this.x + 20, y: this.y + 15, width: this.width - 40, height: this.height - 15 }; }
        getHeadbuttBounds() {
            if (!this.isHeadbutting) return null;
            return { x: this.x + this.width - 25, y: this.y + 10, width: 35, height: 40 };
        }
    }

    class Cactus {
        constructor(x, speed, type) {
            this.x = x; this.type = type; this.markedForDeletion = false; this.isStepped = false;
            if (this.type === 0) { this.width = 45; this.height = 60; }
            else if (this.type === 1) { this.width = 45; this.height = 85; }
            else { this.width = 50; this.height = 95; }
            this.y = CONFIG.GROUND_Y - this.height;
        }
        update(speed) { this.x -= speed; if (this.x + this.width < 0) this.markedForDeletion = true; }
        
        draw(ctx) {
            let imgKey = null;
            if (this.type === 0) imgKey = 'cactus_1';
            else if (this.type === 1) imgKey = 'cactus_2';
            else imgKey = 'cactus_3';
            
            const img = sprites.get(imgKey);

            ctx.save();
            ctx.shadowColor = "rgba(255, 255, 255, 0.8)";
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;

            if (img && img.complete && img.naturalWidth !== 0) {
                if (this.isStepped) {
                    ctx.globalAlpha = 0.5;
                    ctx.translate(0, 20);
                    ctx.shadowBlur = 0;
                }
                ctx.drawImage(img, this.x, this.y, this.width, this.height);
            } else {
                ctx.fillStyle = this.isStepped ? '#777' : '#333'; 
                const yOffset = this.isStepped ? 20 : 0; const hScale = this.isStepped ? 0.6 : 1.0;
                const drawY = this.y + yOffset; const drawH = this.height * hScale;
                
                if (this.type === 0) { ctx.fillRect(this.x + 10, drawY, 10, drawH); ctx.fillRect(this.x, drawY + 20, 8, 15); ctx.fillRect(this.x + 22, drawY + 10, 8, 15); }
                else if (this.type === 1) { ctx.fillRect(this.x + 15, drawY, 15, drawH); ctx.fillRect(this.x, drawY + 25, 12, 25); ctx.fillRect(this.x + 33, drawY + 15, 12, 25); }
                else { ctx.fillRect(this.x + 10, drawY, 10, drawH); ctx.fillRect(this.x, drawY + 20, 8, 15); ctx.fillRect(this.x + 50, drawY, 10, drawH); ctx.fillRect(this.x + 62, drawY + 10, 8, 15); }
            }
            ctx.restore();
        }
        getBounds() { return { x: this.x+5, y: this.y+5, width: this.width-10, height: this.height-10 }; }
    }

    class Cloud {
        constructor(canvasWidth) { this.x = canvasWidth; this.y = Math.random() * 90 + 20; this.speed = 1 + Math.random() * 1.5; this.width = 80; this.height = 40; }
        update() { this.x -= this.speed; if (this.x + this.width < 0) this.markedForDeletion = true; }
        draw(ctx) {
            const img = sprites.get('cloud');
            if (img && img.complete && img.naturalWidth !== 0) {
                 ctx.drawImage(img, this.x, this.y, this.width, this.height);
            } else {
                ctx.fillStyle = '#d0d0d0'; ctx.fillRect(this.x, this.y, this.width, 24); ctx.fillStyle = '#f0f0f0'; ctx.fillRect(this.x, this.y, 20, 10); ctx.fillRect(this.x + 60, this.y, 20, 10);
            }
        }
    }

    class Game {
        constructor() {
            this.canvas = document.getElementById('gameCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.effectContainer = document.getElementById('effect-container');
            
            const resize = () => {
                const container = document.getElementById('game-container');
                this.canvas.width = CONFIG.CANVAS_WIDTH;
                this.canvas.height = CONFIG.CANVAS_HEIGHT;
            };
            window.addEventListener('resize', resize);
            resize();

            this.score = 0; 
            this.highScore = Number(localStorage.getItem(`dinoHighScore_Level${currentLevel}`)) || 0;
            this.gameSpeed = CONFIG.GAME_SPEED_START;
            this.isPlaying = false; this.isGameOver = false;
            this.isDestroyed = false; 
            
            this.hitStopTimer = 0;
            this.dashGauge = 0; this.isDashing = false; this.dashTimer = 0; this.postDashInvincibilityTimer = 0;

            this.bgLayer = new ScrollingLayer('bg', 0.2, 0, false);
            this.groundLayer = new ScrollingLayer('ground', 1.0, 0, true);

            this.dino = new Dino(); this.obstacles = []; this.clouds = []; this.particles = [];
            this.soundManager = soundManager;
            this.ui = {
                current: document.getElementById('current-score'),
                high: document.getElementById('high-score'),
                start: document.getElementById('start-message'),
                over: document.getElementById('game-over-message'),
                gaugeFill: document.getElementById('dash-gauge'),
                btnDash: document.getElementById('btn-dash')
            };

            this.updateHighScoreDisplay();
            
            this.boundHandleKeydown = this.handleKeydown.bind(this);
            this.boundHandleTouch = this.handleTouch.bind(this);
            this.boundHandleMouse = this.handleMouse.bind(this);
            this.boundHandleBtnDash = (e) => { e.preventDefault(); e.stopPropagation(); this.handleInput('dash'); };
            this.boundHandleBtnJump = (e) => { e.preventDefault(); e.stopPropagation(); this.handleInput('jump'); };
            this.boundHandleBtnAtk = (e) => { e.preventDefault(); e.stopPropagation(); this.handleInput('attack'); };

            this.bindEvents();
            this.reset();

            this.fpsInterval = 1000 / CONFIG.FPS;
            this.then = Date.now();
            this.drawLoop();
        }

        bindEvents() {
            window.addEventListener('keydown', this.boundHandleKeydown);
            this.canvas.addEventListener('touchstart', this.boundHandleTouch, { passive: false });
            this.canvas.addEventListener('mousedown', this.boundHandleMouse);

            document.getElementById('btn-dash').addEventListener('touchstart', this.boundHandleBtnDash, { passive: false });
            document.getElementById('btn-dash').addEventListener('mousedown', this.boundHandleBtnDash);
            
            document.getElementById('btn-jump').addEventListener('touchstart', this.boundHandleBtnJump, { passive: false });
            document.getElementById('btn-jump').addEventListener('mousedown', this.boundHandleBtnJump);
            
            document.getElementById('btn-atk').addEventListener('touchstart', this.boundHandleBtnAtk, { passive: false });
            document.getElementById('btn-atk').addEventListener('mousedown', this.boundHandleBtnAtk);
        }

        destroy() {
            this.isDestroyed = true;
            window.removeEventListener('keydown', this.boundHandleKeydown);
            this.canvas.removeEventListener('touchstart', this.boundHandleTouch);
            this.canvas.removeEventListener('mousedown', this.boundHandleMouse);
            
            const removeBtn = (id, handler) => {
                const el = document.getElementById(id);
                el.removeEventListener('touchstart', handler);
                el.removeEventListener('mousedown', handler);
            };
            removeBtn('btn-dash', this.boundHandleBtnDash);
            removeBtn('btn-jump', this.boundHandleBtnJump);
            removeBtn('btn-atk', this.boundHandleBtnAtk);
        }

        handleInput(action) {
            if (this.dino.introPhase) return;

            if (!this.isPlaying && !this.isGameOver) { this.start(); return; }
            if (this.isGameOver) return; 
            
            if (this.isPlaying) {
                if (action === 'jump' && !this.isDashing) {
                    if (this.dino.jump()) this.soundManager.playJump();
                }
                if (action === 'attack' && !this.isDashing) {
                    if (this.dino.triggerHeadbutt()) this.soundManager.playHeadbuttSwing();
                }
                if (action === 'dash') {
                    this.tryStartDash();
                }
            }
        }

        handleKeydown(e) {
            if (['Space', 'ArrowUp', 'ArrowRight', 'ArrowDown', 'KeyG', 'KeyH'].includes(e.code)) e.preventDefault();

            if (this.isGameOver && e.code === 'Space') {
                retryGame();
                return;
            }

            if (e.code === 'Space' || e.code === 'ArrowUp') this.handleInput('jump');
            if (e.code === 'ArrowRight' || e.code === 'KeyH') this.handleInput('attack');
            if (e.code === 'KeyG' || e.code === 'ArrowDown') this.handleInput('dash');
        }
        handleTouch(e) { e.preventDefault(); this.handleInput('jump'); }
        handleMouse(e) { this.handleInput('jump'); }

        start() { this.isPlaying = true; this.ui.start.classList.add('hidden'); }
        reset() {
            this.score = 0; this.gameSpeed = CONFIG.GAME_SPEED_START;
            this.isPlaying = true; 
            this.isGameOver = false;
            this.dashGauge = 0; this.isDashing = false; this.dashTimer = 0; this.postDashInvincibilityTimer = 0;
            this.dino = new Dino(); 
            this.obstacles = []; this.clouds = []; this.particles = [];
            this.spawnTimer = 0; this.hitStopTimer = 0;
            
            this.bgLayer.x = 0;
            this.groundLayer.x = 0;

            this.ui.over.classList.add('hidden'); 
            this.ui.start.classList.add('hidden'); 
            this.effectContainer.innerHTML = '';
            this.updateScoreDisplay(); this.updateGaugeDisplay();
        }
        tryStartDash() {
            if (!this.isDashing && this.dashGauge >= CONFIG.DASH_GAUGE_MAX) {
                this.isDashing = true; this.dashTimer = CONFIG.DASH_DURATION;
                this.postDashInvincibilityTimer = 0; this.soundManager.playDashStart();
            }
        }
        gameOver() {
            this.isPlaying = false; this.isGameOver = true; this.dino.crashed = true;
            this.soundManager.playGameOver(); 
            this.ui.over.classList.remove('hidden');
            if (this.score > this.highScore) { 
                this.highScore = Math.floor(this.score); 
                localStorage.setItem(`dinoHighScore_Level${currentLevel}`, this.highScore); 
                this.updateHighScoreDisplay(); 
            }
        }
        showScoreEffect(x, y, amount, type = 'normal') {
            const el = document.createElement('div');
            el.innerText = `+${amount}`;
            
            if (type === 'smash') {
                el.className = 'score-pop smash';
            } else if (type === 'stomp') {
                el.className = 'score-pop stomp';
            } else {
                el.className = 'score-pop';
            }

            const xPct = (x / this.canvas.width) * 100; const yPct = (y / this.canvas.height) * 100;
            el.style.left = `${xPct}%`; el.style.top = `${yPct}%`;
            this.effectContainer.appendChild(el); setTimeout(() => el.remove(), 800);
        }
        spawnParticles(x, y) { for (let i = 0; i < 15; i++) this.particles.push(new Particle(x, y)); }

        updateEffects() {
            this.particles.forEach(p => p.update());
            this.particles = this.particles.filter(p => p.life > 0);
        }

        update() {
            if (this.dino.introPhase) {
                const finished = this.dino.updateIntro();
                if (!finished) {
                    return;
                } else {
                    this.dino.introPhase = false;
                }
            }

            if (this.hitStopTimer > 0) { this.hitStopTimer--; return; }
            let currentSpeed = this.gameSpeed;
            if (this.isDashing) {
                currentSpeed *= CONFIG.DASH_SPEED_MULTIPLIER;
                this.dashTimer--;
                if (this.dashTimer <= 0) { this.isDashing = false; this.dashGauge = 0; this.postDashInvincibilityTimer = CONFIG.INVINCIBLE_DURATION; }
            } else {
                if (this.dashGauge < CONFIG.DASH_GAUGE_MAX) {
                    const scoreIncrement = 0.1 * (this.gameSpeed / 10);
                    this.dashGauge += scoreIncrement;
                    if (this.dashGauge > CONFIG.DASH_GAUGE_MAX) this.dashGauge = CONFIG.DASH_GAUGE_MAX;
                }
            }
            this.updateGaugeDisplay();
            if (this.postDashInvincibilityTimer > 0) this.postDashInvincibilityTimer--;
            if (this.gameSpeed < CONFIG.MAX_SPEED) this.gameSpeed += CONFIG.ACCELERATION;
            
            const scoreAdd = 0.1 * (currentSpeed / 10); this.score += scoreAdd; this.updateScoreDisplay();
            if (Math.floor(this.score) > 0 && Math.floor(this.score) % 100 === 0 && Math.floor(this.score - scoreAdd * 2) % 100 !== 0) this.soundManager.playScore();

            this.bgLayer.update(currentSpeed);
            this.groundLayer.update(currentSpeed);

            this.dino.update(this.isDashing);
            
            if (Math.random() < 0.008) this.clouds.push(new Cloud(this.canvas.width));
            this.clouds.forEach(c => c.update()); this.clouds = this.clouds.filter(c => !c.markedForDeletion);

            this.spawnTimer--;
            if (this.spawnTimer <= 0) {
                const type = Math.floor(Math.random() * 3);
                this.obstacles.push(new Cactus(this.canvas.width, currentSpeed, type));
                const minRate = CONFIG.SPAWN_RATE_MIN / (currentSpeed / CONFIG.GAME_SPEED_START);
                const maxRate = CONFIG.SPAWN_RATE_MAX / (currentSpeed / CONFIG.GAME_SPEED_START);
                this.spawnTimer = (Math.random() * (maxRate - minRate) + minRate);
            }

            this.obstacles.forEach(obs => {
                obs.update(currentSpeed);
                if (obs.isStepped || obs.markedForDeletion) return;
                const dBox = this.dino.getBounds(); const oBox = obs.getBounds();
                
                if (this.isDashing) {
                    if (dBox.x < oBox.x + oBox.width && dBox.x + dBox.width > oBox.x && dBox.y < oBox.y + oBox.height && dBox.y + dBox.height > oBox.y) {
                         obs.markedForDeletion = true; this.soundManager.playSmash(); this.score += CONFIG.HEADBUTT_SCORE; this.updateScoreDisplay(); 
                         this.showScoreEffect(oBox.x, oBox.y, CONFIG.HEADBUTT_SCORE, 'smash'); 
                         this.spawnParticles(oBox.x + oBox.width/2, oBox.y + oBox.height/2); return;
                    }
                } else if (this.postDashInvincibilityTimer > 0) {
                    if (dBox.x < oBox.x + oBox.width && dBox.x + dBox.width > oBox.x && dBox.y < oBox.y + oBox.height && dBox.y + dBox.height > oBox.y) {
                         obs.markedForDeletion = true; this.soundManager.playSmash(); this.spawnParticles(oBox.x + oBox.width/2, oBox.y + oBox.height/2); return;
                    }
                }

                if (this.dino.isHeadbutting && !this.isDashing) {
                    const hBox = this.dino.getHeadbuttBounds();
                    if (hBox) {
                         if (hBox.x < oBox.x + oBox.width && hBox.x + hBox.width > oBox.x && hBox.y < oBox.y + oBox.height && hBox.y + hBox.height > oBox.y) {
                             obs.markedForDeletion = true; this.soundManager.playSmash(); this.score += CONFIG.HEADBUTT_SCORE; this.updateScoreDisplay(); 
                             this.showScoreEffect(oBox.x, oBox.y, CONFIG.HEADBUTT_SCORE, 'smash'); 
                             this.spawnParticles(oBox.x + oBox.width/2, oBox.y + oBox.height/2); this.hitStopTimer = CONFIG.HIT_STOP_DURATION; this.dino.headbuttCooldown = 0; this.dino.isHeadbutting = false; this.postDashInvincibilityTimer = 0; return; 
                         }
                    }
                }

                if (dBox.x < oBox.x + oBox.width && dBox.x + dBox.width > oBox.x && dBox.y < oBox.y + oBox.height && dBox.y + dBox.height > oBox.y) {
                    const stompThreshold = 25; const isFalling = this.dino.dy > 0; const hitFromTop = (dBox.y + dBox.height) < (oBox.y + stompThreshold);
                    if (isFalling && hitFromTop) {
                        this.dino.bounce(); obs.isStepped = true; this.score += CONFIG.STOMP_SCORE; this.updateScoreDisplay(); this.soundManager.playStomp(); 
                        this.showScoreEffect(oBox.x, oBox.y, CONFIG.STOMP_SCORE, 'stomp'); 
                        this.postDashInvincibilityTimer = 0;
                    } else { 
                        this.spawnParticles(this.dino.x + this.dino.width / 2, this.dino.y + this.dino.height / 2);
                        this.gameOver(); 
                    }
                }
            });
            this.obstacles = this.obstacles.filter(o => !o.markedForDeletion);
        }

        draw() {
            this.ctx.save();
            if (this.isDashing) {
                const shakeX = (Math.random() - 0.5) * 6; const shakeY = (Math.random() - 0.5) * 6; this.ctx.translate(shakeX, shakeY);
            }
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

            this.bgLayer.draw(this.ctx, this.canvas.width, this.canvas.height);
            this.groundLayer.draw(this.ctx, this.canvas.width, this.canvas.height);

            this.clouds.forEach(c => c.draw(this.ctx));
            this.obstacles.forEach(o => o.draw(this.ctx));
            
            if (this.postDashInvincibilityTimer > 0 && Math.floor(Date.now() / 50) % 2 === 0) this.ctx.globalAlpha = 0.5;
            this.dino.draw(this.ctx, this.isDashing);
            this.ctx.globalAlpha = 1.0;

            this.particles.forEach(p => p.draw(this.ctx));

            this.ctx.restore();
        }

        updateScoreDisplay() { this.ui.current.innerText = Math.floor(this.score).toString().padStart(5, '0'); }
        updateHighScoreDisplay() { this.ui.high.innerText = Math.floor(this.highScore).toString().padStart(5, '0'); }
        updateGaugeDisplay() {
            const pct = (this.dashGauge / CONFIG.DASH_GAUGE_MAX) * 100;
            this.ui.gaugeFill.style.width = `${pct}%`;
            if (this.dashGauge >= CONFIG.DASH_GAUGE_MAX) { this.ui.gaugeFill.classList.add('gauge-ready'); this.ui.btnDash.classList.add('active'); }
            else { this.ui.gaugeFill.classList.remove('gauge-ready'); this.ui.btnDash.classList.remove('active'); }
            if (this.isDashing) {
                const remainPct = (this.dashTimer / CONFIG.DASH_DURATION) * 100;
                this.ui.gaugeFill.style.width = `${remainPct}%`;
                this.ui.gaugeFill.classList.add('gauge-ready');
            }
        }

        drawLoop() {
            if (this.isDestroyed) return;

            requestAnimationFrame(() => this.drawLoop());

            const now = Date.now();
            const elapsed = now - this.then;

            if (elapsed > this.fpsInterval) {
                this.then = now - (elapsed % this.fpsInterval);

                this.updateEffects();

                if (this.isPlaying || (this.dino && this.dino.introPhase)) {
                    this.update();
                }
                this.draw();
            }
        }
    }
</script>
</body>
</html>
